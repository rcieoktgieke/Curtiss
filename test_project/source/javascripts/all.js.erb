function insertImageWhenLoaded(imageElement, thumb) {
  setTimeout( function () {
    if (!imageElement.complete) {
      insertImageWhenLoaded(imageElement, thumb);
    }
    else {
      thumb.parentElement.replaceChild(imageElement, thumb);
    }
  }, 100);
}

function replaceGalleryImage(imageElement) {
  thumb = document.getElementById("galleryIndex" + imageElement.getAttribute("gallery-index"));
  //alert("Width: " + thumb.width);
  imageElement.setAttribute("width", thumb.width);
  //alert("Height: " + thumb.height);
  imageElement.setAttribute("height", thumb.height);
  insertImageWhenLoaded(imageElement, thumb);
}

function loadGalleryImages(gallery) {
  galleryIndex = 0;
  for (rowIndex = 0; rowIndex < gallery.length; rowIndex ++) {
    for (colIndex = 0; colIndex < gallery[rowIndex].length; colIndex ++) {
      filename = gallery[rowIndex][colIndex];
      image = document.createElement("IMG");
      image.setAttribute("src", "images/<%= config[:GALLERY_FOLDER] %>/" + filename);
      image.setAttribute("gallery-index", galleryIndex);
      image.addEventListener("loadend", replaceGalleryImage(image));
      galleryIndex += 1;
    }
  }
}

var gallery = [ 
  <% config[:gallery].each do |row| %>
  [
    <% row.each do |filename| %>
      "<%= filename %>",
    <% end %>
  ],
  <% end %>
];
window.onload = function () {
  window.document.body.onload = loadGalleryImages(gallery);
}
